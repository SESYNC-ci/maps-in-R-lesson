---
---

## Leaflet maps in Shiny

Since leaflet outputs a JavaScript object, it integrates particularly well with Shiny applications. Leaflet maps can be embedded in Shiny with the `leafletOutput` (UI-side) and `renderLeaflet` (server-side) functions.

<!--split-->

Open the `lesson-7-2.R` handout. The first part of the code loads libraries, then imports the `counties_md` shapefile and `nlcd_proj` raster. The latter has been pre-projected to Web Mercator for compatibility with leaflet. 

While leaflet performs some projection conversions automatically, fixing raster projections in advance can greatly reduce the app loading time.


~~~r
# Libraries
library(rgdal)
library(raster)
library(leaflet)

# Load data
counties_md <- readOGR("_slides/data/cb_500k_maryland", "cb_500k_maryland")
nlcd_proj <- raster("_slides/data/nlcd_proj.grd")
~~~
{:.text-document title="lesson-7-2.R"}

<!--split-->

### Defining the UI

For the sake of this demonstration, our user interface will be composed of a single `leafletOutput` object inside a `fluidPage` (a flexible Shiny layout).


~~~r
ui <- fluidPage(title = "Interactive Map",
    leafletOutput("sesync_map")
)
~~~
{:.text-document title="lesson-7-2.R"}

<!--split-->

### Defining the server

In the server function, we first specify that the output will be generated by a `renderLeaflet`.


~~~r
server <- function(input, output) {
    output[["sesync_map"]] <- renderLeaflet({
~~~
{:.text-document title="lesson-7-2.R"}

The following `setView` and `addTiles` command produce the same base map as earlier. We then add a point marker at the location of SESYNc, with a popup description


~~~r
        addMarkers(lng = -76.505206, lat = 38.9767231, 
                   popup = "SESYNC") %>%
~~~
{:.text-document title="lesson-7-2.R"}

<!--split-->

### Adding polygon and raster layers

We then add the county outlines with `addPolygons` and the land cover information with `addRasterImage`.


~~~r
        addPolygons(data = counties_md, fill = FALSE)  %>%
        addRasterImage(nlcd_proj, opacity = 0.7, 
                       project = FALSE)
~~~
{:.text-document title="lesson-7-2.R"}

<!--split-->

Here is the complete server function. You are now ready to run the app. 


~~~r
server <- function(input, output) {
    output[["sesync_map"]] <- renderLeaflet({
        leaflet() %>% 
            setView(lng = -76.505206, lat = 38.9767231, 
                    zoom = 8) %>%
            addTiles() %>%
            addMarkers(lng = -76.505206, lat = 38.9767231, 
                       popup = "SESYNC") %>%
            addPolygons(data = counties_md, fill = FALSE)  %>%
            addRasterImage(nlcd_proj, opacity = 0.7, 
                           project = FALSE)
    })    
}
~~~
{:.text-document title="lesson-7-2.R"}

<!--split-->

### Map layer controls

We complete this lesson by adding some interactive control to toggle specific layers on the map. 

Open the `lesson-7-3.R` handout. It is identical to the previous app code, except for a few additional lines in the server function.

<!--split-->

First, notice that we assigned the polygons layer to a `group` named "MD counties".


~~~r
        addPolygons(data = counties_md, fill = FALSE, 
                    group = "MD counties") %>%
~~~
{:.text-document title="lesson-7-3.R"}

<!--split-->

We add two separate raster layers, each produced by masking all but a single land cover class. We put each layer in a group named for its land cover class and assign it a color.


~~~r
        addRasterImage(mask(nlcd_proj, nlcd_proj == 41, 
                            maskvalue = FALSE),
                       group = "Deciduous Forest", 
                       colors = "green", project = FALSE) %>%
        addRasterImage(mask(nlcd_proj, nlcd_proj == 81, 
                            maskvalue = FALSE),
                       group = "Pasture", 
                       colors = "yellow", project = FALSE) %>%
~~~
{:.text-document title="lesson-7-3.R"}

<!--split-->

We then call `addLayersControl` to add controls that toggle between the two rasters (`baseGroups`) with the option of overlaying the county polygons (`overlayGroups`).


~~~r
        addLayersControl(baseGroups = c("Deciduous Forest", 
                                        "Pasture"),
                         overlayGroups = c("MD counties"))
~~~
{:.text-document title="lesson-7-3.R"}

You can now run the app and try the layer controls.

<!--split-->

![leaflet_shiny]({{ site.baseurl }}/images/leafletshiny.png)

In addition to these controls embedded in the map, it is possible to modify a map based on other input objects in the Shiny app. See the [SuperZip app](http://shiny.rstudio.com/gallery/superzip-example.html) in the Shiny gallery for a full example.

---
---

## Leaflet maps in Shiny

Since leaflet outputs a JavaScript object, it integrates particularly well with Shiny applications. Leaflet maps can be embedded in Shiny with the `leafletOutput` (UI-side) and `renderLeaflet` (server-side) functions.

===

Open the `worksheet-2.R` handout. The first part of the code loads libraries, then imports the `counties_md` shapefile and `nlcd_proj` raster. The latter has been pre-projected to Web Mercator for compatibility with leaflet. 

While leaflet performs some projection conversions automatically, fixing raster projections in advance can greatly reduce the app loading time.

```{r leaflet_libs, title = "worksheet-2.R", eval = FALSE}
# Libraries
library(rgdal)
library(raster)
library(leaflet)

# Load data
counties_md <- readOGR("data/cb_500k_maryland", "cb_500k_maryland")
nlcd_proj <- raster("data/nlcd_proj.grd")
```

===

### Defining the UI

For the sake of this demonstration, our user interface will be composed of a single `leafletOutput` object inside a `fluidPage` (a flexible Shiny layout).

```{r leaflet_ui, title = "worksheet-2.R", eval = FALSE}
ui <- fluidPage(title = "Interactive Map",
    leafletOutput("sesync_map")
)
```

===

### Defining the server

In the server function, we first specify that the output will be generated by a `renderLeaflet`.

```{r leaflet_server1, title = "worksheet-2.R", eval = FALSE}
server <- function(input, output) {
    output[["sesync_map"]] <- renderLeaflet({
```

The following `setView` and `addTiles` command produce the same base map as earlier. We then add a point marker at the location of SESYNc, with a popup description

```{r leaflet_server2, title = "worksheet-2.R", eval = FALSE}
        addMarkers(lng = -76.505206, lat = 38.9767231, 
                   popup = "SESYNC") %>%
```

===

### Adding polygon and raster layers

We then add the county outlines with `addPolygons` and the land cover information with `addRasterImage`.

```{r leaflet_server3, title = "worksheet-2.R", eval = FALSE}
        addPolygons(data = counties_md, fill = FALSE)  %>%
        addRasterImage(nlcd_proj, opacity = 0.7, 
                       project = FALSE)
```

===

Here is the complete server function. You are now ready to run the app. 

```{r leaflet_server_full, title = "worksheet-2.R", eval = FALSE}
server <- function(input, output) {
    output[["sesync_map"]] <- renderLeaflet({
        leaflet() %>% 
            setView(lng = -76.505206, lat = 38.9767231, 
                    zoom = 8) %>%
            addTiles() %>%
            addMarkers(lng = -76.505206, lat = 38.9767231, 
                       popup = "SESYNC") %>%
            addPolygons(data = counties_md, fill = FALSE)  %>%
            addRasterImage(nlcd_proj, opacity = 0.7, 
                           project = FALSE)
    })    
}
```

===

### Map layer controls

We complete this lesson by adding some interactive control to toggle specific layers on the map. 

Open the `worksheet-3.R` handout. It is identical to the previous app code, except for a few additional lines in the server function.

===

First, notice that we assigned the polygons layer to a `group` named "MD counties".

```{r leaflet_poly_group, title = "worksheet-3.R", eval = FALSE}
        addPolygons(data = counties_md, fill = FALSE, 
                    group = "MD counties") %>%
```

===

We add two separate raster layers, each produced by masking all but a single land cover class. We put each layer in a group named for its land cover class and assign it a color.

```{r leaflet_rast_group, title = "worksheet-3.R", eval = FALSE}
        addRasterImage(mask(nlcd_proj, nlcd_proj == 41, 
                            maskvalue = FALSE),
                       group = "Deciduous Forest", 
                       colors = "green", project = FALSE) %>%
        addRasterImage(mask(nlcd_proj, nlcd_proj == 81, 
                            maskvalue = FALSE),
                       group = "Pasture", 
                       colors = "yellow", project = FALSE) %>%
```

===

We then call `addLayersControl` to add controls that toggle between the two rasters (`baseGroups`) with the option of overlaying the county polygons (`overlayGroups`).

```{r leaflet_control, title = "worksheet-3.R", eval = FALSE}
        addLayersControl(baseGroups = c("Deciduous Forest", 
                                        "Pasture"),
                         overlayGroups = c("MD counties"))
```

You can now run the app and try the layer controls.

===

![leaflet_shiny]({{ site.baseurl }}/images/leafletshiny.png)

In addition to these controls embedded in the map, it is possible to modify a map based on other input objects in the Shiny app. See the [SuperZip app](http://shiny.rstudio.com/gallery/superzip-example.html) in the Shiny gallery for a full example.
